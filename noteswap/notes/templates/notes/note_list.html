{% extends "notes/base.html" %}
{% block content %}
  <div class="row">
    <div class="col-md-6">
      <h2>Upload a Note</h2>
      <form id="uploadForm" enctype="multipart/form-data" class="card p-3 shadow-sm mb-4">
        {% csrf_token %}
        <div class="mb-3">
          <input type="text" name="title" class="form-control" placeholder="Title" required>
        </div>
        <div class="mb-3">
          <input type="text" name="subject" class="form-control" placeholder="Subject" required>
        </div>
        <div class="mb-3">
          <input type="text" name="course" class="form-control" placeholder="Course" required>
        </div>
        <div class="mb-3">
          <input type="text" name="semester" class="form-control" placeholder="Semester" required>
        </div>
        <div class="mb-3">
          <input type="file" name="file" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Upload</button>
        <span id="uploadStatus" class="ms-2"></span>
      </form>
    </div>
    <div class="col-md-6">
      <h2>All Notes</h2>
      <div class="card p-3 mb-4">
        <form id="filterForm" class="row gy-2 gx-3 align-items-center">
          <div class="col-sm-3">
            <input type="text" class="form-control" name="search" placeholder="Search...">
          </div>
          <div class="col-sm-2">
            <input type="text" class="form-control" name="subject" placeholder="Subject">
          </div>
          <div class="col-sm-2">
            <input type="text" class="form-control" name="course" placeholder="Course">
          </div>
          <div class="col-sm-2">
            <input type="text" class="form-control" name="semester" placeholder="Semester">
          </div>
          <div class="col-auto">
            <button type="submit" class="btn btn-outline-primary px-4">Filter</button>
          </div>
          <div class="col-auto">
            <button type="button" id="clearFilters" class="btn btn-outline-secondary px-4">Clear</button>
          </div>
        </form>
      </div>
      <ul id="notesList" class="list-group"></ul>
    </div>
  </div>
  <script>
    // CSRF token setup for AJAX
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // Fetch and render notes
    function loadNotes(params = {}) {
      const url = new URL("{% url 'note_api' %}", window.location.origin);
      Object.keys(params).forEach(key => {
        if (params[key]) url.searchParams.append(key, params[key]);
      });

      fetch(url)
        .then(response => response.json())
        .then(data => {
          const notesList = document.getElementById('notesList');
          notesList.innerHTML = '';
          if (data.notes.length === 0) {
            notesList.innerHTML = '<li class="list-group-item">No notes uploaded yet.</li>';
          } else {
            data.notes.forEach(note => {
              notesList.innerHTML += `
                <li class="list-group-item mb-2">
                  <div class="fw-bold">${note.title}</div>
                  <div class="text-muted small mb-1">
                    ${note.subject} | ${note.course} | ${note.semester}
                  </div>
                  <div class="mb-1">
                    Uploaded by <span class="fw-semibold">${note.uploader}</span> on ${note.uploaded_at}
                  </div>
                  <a href="${note.file_url}" class="btn btn-sm btn-outline-primary" target="_blank">Download</a>
                  <div class="mt-2">
                    <span>Rate: </span>
                    <span class="star-rating" data-note="${note.id}">
                      ${[1,2,3,4,5].map(star => `<i class="bi bi-star" data-value="${star}"></i>`).join('')}
                    </span>
                    <span class="avg-rating" id="avg-rating-${note.id}"></span>
                  </div>
                  <div class="mt-2">
                    <form class="comment-form" data-note="${note.id}">
                      <div class="input-group input-group-sm">
                        <input type="text" class="form-control" name="text" placeholder="Add a comment...">
                        <button class="btn btn-outline-secondary" type="submit">Post</button>
                      </div>
                    </form>
                    <ul class="comments-list" id="comments-${note.id}"></ul>
                  </div>
                </li>
              `;
            });
          }
        });
    }

    // Handle upload form submit
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      fetch("{% url 'note_api' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          document.getElementById('uploadStatus').textContent = 'Uploaded!';
          form.reset();
          loadNotes();
        } else {
          document.getElementById('uploadStatus').textContent = 'Error: ' + JSON.stringify(data.errors);
        }
      })
      .catch(() => {
        document.getElementById('uploadStatus').textContent = 'Upload failed.';
      });
    });

    // Filter form handler
    document.getElementById('filterForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(e.target);
      const params = {};
      formData.forEach((value, key) => {
        params[key] = value;
      });
      loadNotes(params);
    });

    // Clear filters handler
    document.getElementById('clearFilters').addEventListener('click', function() {
      document.getElementById('filterForm').reset();
      loadNotes();
    });

    // Handle star rating click
    document.addEventListener('click', function(e) {
      if (e.target.matches('.star-rating i')) {
        const noteId = e.target.closest('.star-rating').dataset.note;
        const value = e.target.dataset.value;
        fetch(`/notes/api/${noteId}/rate/`, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken},
          body: new URLSearchParams({value})
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`avg-rating-${noteId}`).textContent = `Avg: ${data.avg_rating.toFixed(1)}`;
          }
        });
      }
    });

    // Handle comment form submit
    document.addEventListener('submit', function(e) {
      if (e.target.matches('.comment-form')) {
        e.preventDefault();
        const noteId = e.target.dataset.note;
        const text = e.target.elements.text.value;
        fetch(`/notes/api/${noteId}/comment/`, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken},
          body: new URLSearchParams({text})
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            const commentsList = document.getElementById(`comments-${noteId}`);
            commentsList.innerHTML += `<li><b>${data.comment.user}</b>: ${data.comment.text} <span class="text-muted small">(${data.comment.created_at})</span></li>`;
            e.target.reset();
          }
        });
      }
    });

    // Initial load
    loadNotes();
  </script>
{% endblock %}